<html>
  <head>
      <meta charset="utf-8" />
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
      <script src="https://unpkg.com/pdf-lib@1.16.0/dist/pdf-lib.min.js"></script>
      <script src="https://unpkg.com/downloadjs@1.4.7"></script>
      <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.js"></script>
      <script src="print/print.min.js"></script>
      <title>Generator dokumentów meczowych</title>
      <link rel="icon" href="icon.ico">
      <link rel="preconnect" href="https://fonts.gstatic.com">
      <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Eczar&family=Yanone+Kaffeesatz:wght@700&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="style.css">
      <style id="style"></style>
  </head>
  <body>
    <div id="contener">
        <div id="titleContener"><h1>Generator dokumentów meczowych</h1></div>
        <div id="contenerMainSettings">
            <table class="table" id="table_defaultSettings">
                <tr><th colspan="2">Podstawowe ustawienia</th></tr>
                <tr id="tableAddOptionHead">
                    <th>Rodzaj rozgrywek ligowych</th>
                    <td> <select id="mainSetting_rodzaj" class="select_main" onChange="mainSetting_afterChangeKind()">
                        <option value="SM" checked>Superliga Mężczyzn</option>
                        <option value="CLJ">CLJ</option>
                    </select> </td>
                </tr>
                <tr id="tableAddOptionHead">
                    <th>Rodzaj czcionki w pliku PDF</th>
                    <td><select id="mainSetting_font" class="select_main" onclick="mainSetting_afterChangeFonts()"></select></td>
                </tr>
            </table>
            <table class="table">
                <tr><th>Karty zmian i inne</th></tr>
                <tr> <td> <select class="kartyZmian_select">
                    <option value=0 selected="selected">Gospodarz zmiana 1.</option>
                    <option value=1>Gospodarz zmiana 2.</option>
                    <option value=2>Gość zmiana 1.</option>
                    <option value=3>Gość zmiana 2.</option>
                    <option value=4>Karta gry zawodnika</option>
                </select> </td> </tr>
                <tr> <td> <select class="kartyZmian_select">
                    <option value=0>Gospodarz zmiana 1.</option>
                    <option value=1 selected="selected">Gospodarz zmiana 2.</option>
                    <option value=2>Gość zmiana 1.</option>
                    <option value=3>Gość zmiana 2.</option>
                    <option value=4>Karta gry zawodnika</option>
                </select> </td> </tr>
                <tr> <td> <select class="kartyZmian_select">
                    <option value=0>Gospodarz zmiana 1.</option>
                    <option value=1>Gospodarz zmiana 2.</option>
                    <option value=2 selected="selected">Gość zmiana 1.</option>
                    <option value=3>Gość zmiana 2.</option>
                    <option value=4>Karta gry zawodnika</option>
                </select> </td> </tr>
                <tr> <td> <select class="kartyZmian_select">
                    <option value=0>Gospodarz zmiana 1.</option>
                    <option value=1>Gospodarz zmiana 2.</option>
                    <option value=2>Gość zmiana 1.</option>
                    <option value=3 selected="selected">Gość zmiana 2.</option>
                    <option value=4>Karta gry zawodnika</option>
                </select> </td> </tr>
                <tr> <th> 
                    <label class="labelCheckbox">
                        <button onclick="kartyZmian_onPrint()" id="kartyZmian_print" class="printButton"> Drukuj karty zmian </button>
                    </label> 
                    <label class="labelCheckbox">
                        <button onclick="kartyZmian_onSave()" id="kartyZmian_save" class="printButton"> Zapisz karty zmian </button>
                    </label> 
                </th> </tr>
            </table>
        </div>
        <div id="colLeft">
            <table class="table">
                <tr> <th colspan="2">Karta zgłoszenia drużyny do gry</th> </tr>
                <tr id="tableAddOptionHead">
                    <th>Miejscowość</th>
                    <td><input tyle="text" id="zgloszenieDruzyny_miejscowosc" value="Gostyń"></td>
                </tr>
                <tr id="tableAddOptionHead">
                    <th>Data</th>
                    <td><input tyle="text" id="zgloszenieDruzyny_data"></td>
                </tr>
                <tr id="tableAddOptionHead">
                    <th title="Wpisanie w kolumnie 'Nr Startowy' kolejnych liczb"> Wpisanie liczb w kolumnie "Nr startowy" </th>
                    <td><label class="labelCheckbox">
                        <input type="checkbox" class="checkbox" id="zgloszenieDruzyny_numbersInNrStart" checked>
                    </label></td>
                </tr>
                <tr> <th colspan="2"> <table id="zgloszenieDruzyny_tablePlayer"></table> </th> </tr>
                <tr id="tableAddOptionHead">
                    <th title="Dodanie do pliku drugiego egzemplarza Zgłoszenia Drużyny"> Drugi egzemplarz Zgłoszenia Drużyny </th>
                    <td> <label class="labelCheckbox">
                        <input type="checkbox" class="checkbox" id="zgloszenieDruzyny_drugiEgzemplarz" checked>
                    </label> </td>
                </tr>
                <tr> <th colspan="2">
                    <label class="labelCheckbox">
                        <button onclick="zgloszenieDruzyny_onPrint()" id="zgloszenieDruzyny_print" class="printButton"> Drukuj zgłoszenie drużyny </button>
                    </label>
                    <label class="labelCheckbox">
                        <button onclick="zgloszenieDruzyny_onSave()" id="zgloszenieDruzyny_save" class="printButton"> Zapisz zgłoszenie drużyny </button>
                    </label>
                </th> </tr>
            </table>
        </div>
        <div id="colRight">
            <table class="table tableMarginBottom">
                <tr><th colspan="3">Karty gry zawodników</th></tr>
                <tr>
                    <th>Kolejność kart zawodników</th>
                    <td colspan="2"> <select id="kartaGryZawodnika_kolejnoscKart">
                        <option value=0>Drukowanie kart naprzemiennie gospodarz i gość</option>
                        <option value=1>Drukowanie kart najpierw gospodarze</option>
                    </select> </td>
                </tr> 
                <tr>
                    <th>Co wpisać w linii <b class="specialFont">"MECZ"</b></th>
                    <td colspan="2"> <input tyle="text" id="kartaGryZawodnika_nameMecz"> </td>
                </tr>
                <tr> 
                    <td> </td> 
                    <th>Gospodarz</th> 
                    <th>Gość</th> 
                </tr>
                <tr>
                    <th>Drużyna</th>
                    <td>KS Start Gostyń</td>
                    <th id="kartyGryZawodnika_selectTeamContener"></th></tr>
                <tr>
                    <th>Wpisać <b class="specialFont">"Drużynę"</b></th>
                    <td><label class="labelCheckbox"> <input type="checkbox" class="checkbox" id="kartyGryZawodnika_nameTeam_home" checked> </label></td>
                    <td><label class="labelCheckbox"> <input type="checkbox" class="checkbox" id="kartyGryZawodnika_nameTeam_guest" checked> </label></td>
                </tr>
                <tr>
                    <th>Wpisać <b class="specialFont">"MECZ"</b></th>
                    <td> <label class="labelCheckbox"> <input type="checkbox" class="checkbox" id="kartyGryZawodnika_mecz_home" checked> </label></td>
                    <td> <label class="labelCheckbox"> <input type="checkbox" class="checkbox" id="kartyGryZawodnika_mecz_guest" checked> </label></td>
                </tr>
                <tr>
                    <th>Wpisać <b class="specialFont">"Tory"</b></th>
                    <td> <label class="labelCheckbox"> <input type="checkbox" class="checkbox" id="kartyGryZawodnika_tory_home" checked> </label> </td>
                    <td> <label class="labelCheckbox"> <input type="checkbox" class="checkbox" id="kartyGryZawodnika_tory_guest" checked> </label> </td>
                </tr>
                <tr>
                    <th>Wpisać <b class="specialFont">"Nr Startowe"</b></th>
                    <td> <label class="labelCheckbox"> <input type="checkbox" class="checkbox" id="kartyGryZawodnika_nrStart_home" checked> </label> </td>
                    <td> <label class="labelCheckbox"> <input type="checkbox" class="checkbox" id="kartyGryZawodnika_nrStart_guest" checked> </label> </td>
                </tr>
                <tr><td colspan="3"><table id="kartyGryZawodnika_tablePlayer"></table></td></tr>
                <tr><th colspan="3">
                    <label class="labelCheckbox">
                        <button onclick="kartyGryZawodnika_onPrint()" id="kartyZmian_print" class="printButton"> Drukuj karty gry zawodników </button>
                    </label>
                    <label class="labelCheckbox">
                        <button onclick="kartyGryZawodnika_onSave()" id="kartyZmian_save" class="printButton"> Zapisz karty gry zawodników </button>
                    </label>
                </th></tr>
            </table>
        </div>
    </div>
  </body>
    <script>
        const { degrees, PDFDocument, rgb, StandardFonts, PDFObject } = PDFLib;
        const name_team = "KS Start Gostyń";
        const player = {
            SM: [
                ["Szymon", "Banaszak", "06.07.2000", "2057/10"],
                ["Dominik", "Dutkiewicz", "10.11.2006", "2783/19"],
                ["Włodzimierz", "Dutkiewicz", "30.04.1969", "219/97"],
                ["Mikołaj", "Kosowicz", "09.08.1996", "2320/12"],
                ["Patryk", "Lukaszewski", "06.06.2000", "2267/11"],
                ["Jędrzej", "Michalak", "09.08.1997", "2055/10"],
                ["Jakub", "Osiewicz", "26.05.1985", "403/97"],
                ["Marek", "Podyma", "28.03.1955", "2002/10 B"],
                ["Mateusz", "Ptak", "28.08.2004", "2512/14"],
                ["Karol", "Sellmann", "08.11.1995", "1847/08"],
                ["Andrzej", "Zagata", "30.11.1972", "264/97"],
                ["Bogusław", "Zagata", "23.09.1971", "2047/10 B"],
                ["Krzysztof", "Zagata", "04.10.1996", "1675/06"]
            ],
            CLJ: [
                ["Patryk", "Lukaszewski", "06.06.2000", "2267/11"],
                ["Szymon", "Banaszak", "06.07.2000", "2057/10"],
                ["Mateusz", "Ptak", "28.08.2004", "2512/14"],
                ["Aleksandra", "Kuc", "26.07.2005", "2811/18"],
                ["Aleksandra", "Banaszak", "10.02.2004", "2391/12"],
                ["Wiktoria", "Poznańska", "31.10.2005", "2745/17"],
                ["Dominik", "Dutkiewicz", "10.11.2006", "2783/19"],
                ["Julia", "Łagódka", "26.09.2006", "2810/18"]
            ]
        };
        const kinds_details = {SM: {players: 6, reserve: 4}, CLJ: {players: 4, reserve: 3}};
        const fonts = [
            'font/VT323.ttf',
            'font/IBM.ttf',
            'font/Syne.ttf',
            'font/Beanie.ttf',
            'https://pdf-lib.js.org/assets/ubuntu/Ubuntu-R.ttf',
            "font/Roboto.ttf",
            "font/Cookie.ttf"
        ]
        let list_player = null
        
        loadSite()
        
        async function loadSite() {
            list_player = await getPlayerFromLicencja()
            mainSetting_addFontsToStyle();
            mainSetting_createSelectFonts()
            mainSetting_afterChangeKind();
            document.getElementById("zgloszenieDruzyny_data").value = getToday();
        }
        
        function mainSetting_createSelectFonts() {
            let listFont = "";
            for(let i=0; i<fonts.length; i++) listFont += `<option>Przykładowy tekst | KS Start Gostyń | Kręgle</option>`
            document.getElementById("mainSetting_font").innerHTML = listFont;
            const child = document.getElementById("mainSetting_font").children;
            for(let i=0; i<child.length; i++) {
                child[i].style.fontFamily = "'"+fonts[i]+"'";
                child[i].id = fonts[i];
            }
            mainSetting_afterChangeFonts();
        }
        
        function mainSetting_addFontsToStyle() {
            let listFont = '';
            for(let i=0; i<fonts.length; i++) listFont += `@font-face {font-family:'` + fonts[i] + `'; src: url('`+fonts[i] +`')}`;
            document.getElementById("style").innerHTML += listFont;
        }
        
        function mainSetting_afterChangeFonts() {
            const el = document.getElementById("mainSetting_font");
            const index = el.selectedIndex;
            el.style.fontFamily = "'"+fonts[index]+"'";
            el.style.fontSize = el.children[index].style.fontSize;
        }
        
        function mainSetting_afterChangeKind() {
            //funkcja uruchamiana jest przy tworzeniu strony i po zmianie rodzaju rozgrywek
            const rodzaj = document.getElementById("mainSetting_rodzaj").value;
            const playerList = player[rodzaj]
            const positionInTeam = zgloszenieDruzyny_getPositionInTeam(kinds_details[rodzaj])
            const playerSelect = zgloszenieDruzyny_createSelectPlayer(playerList)
            const text_tablePlayer = zgloszenieDruzyny_createTablePlayer(positionInTeam, playerSelect)
            
            document.getElementById("zgloszenieDruzyny_tablePlayer").innerHTML = text_tablePlayer;
            document.getElementById("kartaGryZawodnika_nameMecz").value = "Mecz "+rodzaj+" nr ";
            
            kartyGryZawodnikow_afterChangeKind(rodzaj)
        }
        
        function zgloszenieDruzyny_createTablePlayer(positionInTeam, player_select) {
            let text = "<tr><th colspan=2>Wybór graczy</th></tr>"
            text += "<tr><th>Pozycja</th><th>Imię i nazwisko gracza</th></tr>";
            for(let i=0; i<positionInTeam.length; i++) 
                text += `<tr class='tablePlayerRow'><td>`+positionInTeam[i]+`</td><td>`+player_select+`</td></tr>`;
            return text
        }
        
        function zgloszenieDruzyny_getPositionInTeam(kind_details) {
            let positionInTeam = []
            for( let i=1; i<=kind_details["players"]; i++) positionInTeam.push("Gracz "+i+".")
            for( let i=1; i<=kind_details["reserve"]; i++) positionInTeam.push("Rezerwowy "+i+".")
            return positionInTeam
        }
        
        function zgloszenieDruzyny_createSelectPlayer(list_player) {
            let text_select = `<select 
                                    class='zgloszenieDruzyny_selectPlayer' 
                                    onChange='zgloszenieDruzyny_afterChoosePlayer()'
                                >
                                    <option value='-1' checked></option>`
            for( let i=0; i<list_player.length; i++) {
                player_name = list_player[i][1]+" "+list_player[i][0]
                text_select += "<option value='"+i+"'>"+ player_name +"</option>"
            } 
            text_select += "</select>"
            return text_select
        }
        
        function zgloszenieDruzyny_afterChoosePlayer() {
            list_selectPlayer = document.getElementsByClassName("zgloszenieDruzyny_selectPlayer")
            list_choose_index = zgloszenieDruzyny_getListChooseIndexPlayer(list_selectPlayer)
            zgloszenieDruzyny_selectPlayer_deleteAdditionalClass(list_selectPlayer)
            zgloszenieDruzyny_selectPlayer_checkPlayerMultipleSelections(list_selectPlayer)
            zgloszenieDruzyny_changePlayerHomeInKartyZmian(list_choose_index)
        }
        
        function zgloszenieDruzyny_getListChooseIndexPlayer(list_selectPlayer) {
            list_choose_index = []
            for( let i=0; i<list_selectPlayer.length; i++) list_choose_index.push(list_selectPlayer[i].value)
            return list_choose_index
        }
        
        function zgloszenieDruzyny_selectPlayer_deleteAdditionalClass(list_selectPlayer) {
            for( let i=0; i<list_selectPlayer.length; i++) {
                el = list_selectPlayer[i].parentElement.parentElement
                el.classList.remove("error__playerSelectedMultipleTimes")
                el.title = ""
            }
        }
        
        function zgloszenieDruzyny_selectPlayer_checkPlayerMultipleSelections(list_selectPlayer) {
            let list_index_multiple = []
            for(let i=0; i<list_choose_index.length; i++) {
                if( list_choose_index[i] == -1 ) continue
                for(let j=i+1; j<list_choose_index.length; j++) {
                    if( list_choose_index[i] != list_choose_index[j]) continue
                    list_index_multiple.push(i)
                    list_index_multiple.push(j)
                }
            }
            list_index_multiple = [...new Set(list_index_multiple)]
            for( let i=0; i<list_index_multiple.length; i++) {
                el = list_selectPlayer[list_index_multiple[i]].parentElement.parentElement;
                el.classList.add("error__playerSelectedMultipleTimes")
                el.title = "Gracz został wybrany kilkukrotnie"
            }
        }
        
        function zgloszenieDruzyny_changePlayerHomeInKartyZmian(list_choose_index) {
            const rodzaj = document.getElementById("mainSetting_rodzaj").value;
            const home_player = player[rodzaj]
            const list_kartyZmian_selectHomePlayer = document.getElementsByClassName("kartyGryZawodnika_playerSelect_home")
            
            for( let i=0; i<list_kartyZmian_selectHomePlayer.length; i++ ) {
                let choose_player = ""
                let index =  list_choose_index[i]
                if( index != -1 ) choose_player = home_player[index][1]+" "+home_player[index][0]
                const list_option = list_kartyZmian_selectHomePlayer[i].getElementsByTagName("option")
                for( let j=0; j<list_option.length; j++) {
                    if( list_option[j].value == choose_player ) list_option[j].selected = "selected";
                }
            }
        }
        
        function getToday() {
            let date = new Date().toJSON().slice(0,10).split("-");
            return date[2]+"."+date[1]+"."+date[0];
        }
        
        async function zgloszenieDruzyny_createPdf() {
            const listChoosePlayer = zgloszenieDruzyny_getListChoosePlayer()
            const nameTown = document.getElementById("zgloszenieDruzyny_miejscowosc").value;
            const date = document.getElementById("zgloszenieDruzyny_data").value;
            const printNrStart = document.getElementById("zgloszenieDruzyny_numbersInNrStart").checked;
            const drugiEgzemplarz = document.getElementById("zgloszenieDruzyny_drugiEgzemplarz").checked;
            const rodzaj = document.getElementById("mainSetting_rodzaj").value;
            const last_index = zgloszenieDruzyny_getLastIndexPlayer(listChoosePlayer[0], rodzaj)
            
            let strony = [0]
            if( drugiEgzemplarz ) strony.push(0)
            pdfDoc = await pdfDoc_getEmptyForm(strony)
            const pages = pdfDoc.getPages()
            const skala = pdfDoc_getScala(pages[0])
            const howManyRow = zgloszenieDruzyny_getLastIndexPlayer(listChoosePlayer[0], rodzaj)
            
            const font = await pdfDoc_getFont()
            
            pdfDoc_zgloszenieDruzyny_markKind(pages[0], rodzaj, skala)
            pdfDoc_zgloszenieDruzyny_drawOtherInformation(pages[0], nameTown, date, skala, font)
            pdfDoc_zgloszenieDruzyny_drawPlayerDetails(pages[0], howManyRow, printNrStart, listChoosePlayer, skala, font)
            return pdfDoc
        }

        async function zgloszenieDruzyny_onPrint() {
            const pdfDoc = await zgloszenieDruzyny_createPdf()
            pdfDoc_print(pdfDoc)
        }

        async function zgloszenieDruzyny_onSave() {
            const pdfDoc = await zgloszenieDruzyny_createPdf()
            pdfDoc_download(pdfDoc, "zgloszenieDruzyny")
        }
        
        async function pdfDoc_getEmptyForm(list_number_site) {
            //funkja zwraca pusty dokument pdf
            const url = "pdf/main.pdf"
            const existingPdfBytes = await fetch(url).then(res => res.arrayBuffer())
            const cleanPdf = await PDFDocument.load(existingPdfBytes);
            const pdfDoc = await PDFDocument.create();
            const copiedPages = await pdfDoc.copyPages(cleanPdf, list_number_site);
            for(let i=0; i<copiedPages.length; i++) pdfDoc.addPage(copiedPages[i])
            return pdfDoc
        }
        
        async function pdfDoc_print(pdfDoc) {
            //funkcja odpowiada za pokazanie okienka do drukowania z przekazanym plikiem pdf
            const pdfByte = await pdfDoc.save()
            var blob = new Blob([pdfByte], {type: "application/pdf"});
            var link = window.URL.createObjectURL(blob);
            printJS({printable: link, maxWidth: 1900});
        }

        async function pdfDoc_download(pdfDoc, name) {
            //funkcja odpowiada za pobranie przkazanego pdf
            const d = new Date()
            const stringDate = d.getFullYear() + "_" + (d.getMonth() + 1) + "_" + d.getDate()
            const pdfByte = await pdfDoc.save()
            var blob = new Blob([pdfByte], {type: "application/pdf"});
            var link=document.createElement('a');
            link.href=window.URL.createObjectURL(blob);
            link.download=name + "_" + stringDate + ".pdf";
            link.click();
        }
        
        function pdfDoc_zgloszenieDruzyny_markKind(page, rodzaj, skala, color=rgb(0, 0, 0)) {
            const rodzajWsp = {
                SM: [
                    {start: {x: 176.5*skala, y: 1019*skala}, end: {x: 199*skala, y: 1035*skala}},
                    {start: {x: 176.5*skala, y: 1035*skala}, end: {x: 199*skala, y: 1019*skala}}
                ],
                CLJ: [
                    {start: {x: 176.5*skala, y: 992.5*skala}, end: {x: 198.8*skala, y: 1010.9*skala}},
                    {start: {x: 176.5*skala, y: 1010.9*skala}, end: {x: 198.8*skala, y: 992.5*skala}}
                ]
            }
            list_wsp = rodzajWsp[rodzaj]
            for(let i=0; i<2; i++) {
                page.drawLine({
                  start: { x: list_wsp[i].start.x, y: list_wsp[i].start.y },
                  end: { x: list_wsp[i].end.x, y: list_wsp[i].end.y},
                  thickness: 2,
                  color
                })   
            }
        }
        
        function pdfDoc_zgloszenieDruzyny_drawOtherInformation(page, nameTown, date, skala, font, color=rgb(0, 0, 0)) {
            let fontSize = pdfDoc_getMaxFontSize(font, 32, 510, "KS Start Gostyń")
            pdfDoc_drawCenterText(page, "KS Start Gostyń", 906, 199, 709, font, fontSize, skala)
            
            fontSize = pdfDoc_getMaxFontSize(font, 28, 155, nameTown)
            pdfDoc_drawCenterText(page, nameTown, 358, 325, 580, font, fontSize, skala)
            
            fontSize = pdfDoc_getMaxFontSize(font, 25, 155, nameTown)
            pdfDoc_drawCenterText(page, date, 306, 325, 580, font, fontSize, skala)
        }
        
        function pdfDoc_zgloszenieDruzyny_drawPlayerDetails(page, howManyRow, printNrStart, listChoosePlayer, skala, font, color=rgb(0, 0, 0)) {
            listNrStart = []
            for( let i=1; i<=howManyRow; i++) listNrStart.push(i.toString())
            let longestWords = []
            for(let i=0; i<3; i++) longestWords.push(pdfDoc_findLongestWordInArray(listChoosePlayer[i], font))
            let listMaxWidth = [231, 111, 131]
            const fontSize = pdfDoc_zgloszenieDruzyny_rowPlayer_maxFontSize(font, 30, listMaxWidth, longestWords, skala)
            const theWidestNrStart = pdfDoc_findLongestWordInArray(listNrStart, font)
            const fontSizeNrStart = pdfDoc_getMaxFontSize(font, 50*skala, 59*skala, theWidestNrStart)
            const startY = 834
            for( let i=0; i<howManyRow; i++) {
                y = startY - i*44
                if(printNrStart) pdfDoc_drawCenterText(page, listNrStart[i], y, 117, 175, font, fontSizeNrStart, skala)
                pdfDoc_drawText(page, listChoosePlayer[0][i], y, 210, font, fontSize, skala)
                pdfDoc_drawCenterText(page, listChoosePlayer[1][i], y, 469, 580, font, fontSize, skala)
                pdfDoc_drawCenterText(page, listChoosePlayer[2][i], y, 598, 709, font, fontSize, skala)
            }
        }
        
        function pdfDoc_zgloszenieDruzyny_rowPlayer_maxFontSize(font, maxHeight, list_maxWidth, list_text, skala) {
            fontSize = -1
            for( let i=0; i<list_maxWidth.length; i++) {
                size = pdfDoc_getMaxFontSize(font, maxHeight*skala, list_maxWidth[i]*skala, list_text[i])
                if( fontSize == -1 || size < fontSize) fontSize = size
            }
            return fontSize
        }
        
        function pdfDoc_getScala(page) {
            const { width, height } = page.getSize()
            const skala = width/826;
            return skala
        }
        
        async function pdfDoc_getFont() {
            const checkedFont = document.getElementById('mainSetting_font').selectedIndex;
            const urlFont = fonts[checkedFont];
            const fontBytes = await fetch(urlFont).then((res) => res.arrayBuffer())
            pdfDoc.registerFontkit(fontkit)
            const font = await pdfDoc.embedFont(fontBytes);
            return font
        }
        
        function pdfDoc_drawCenterText(page, text, y, leftX, rightX, font, fontSize, skala, color=rgb(0, 0, 0)) {
            const x = ((rightX-leftX)*skala - font.widthOfTextAtSize(text, fontSize) )/2 + leftX*skala;
            page.drawText(text, {x, y: y*skala, size: fontSize, font, color})
        }
        
        function pdfDoc_drawText(page, text, y, x, font, fontSize, skala, color=rgb(0, 0, 0)) {
            page.drawText(text, {x: x*skala, y: y*skala, size: fontSize, font, color})
        }
        
        function pdfDoc_getMaxFontSize(font, maxHeight, maxWidth, text) {
            let size = 1;
            while(font.widthOfTextAtSize(text, size) < maxWidth && font.heightAtSize(size) < maxHeight) size += 0.1;
            return size;
        }
        
        function zgloszenieDruzyny_getListChoosePlayer() {
            const list_selectPlayer = document.getElementsByClassName("zgloszenieDruzyny_selectPlayer")
            const list_choose_index = zgloszenieDruzyny_getListChooseIndexPlayer(list_selectPlayer)
            const rodzaj = document.getElementById("mainSetting_rodzaj").value;
            const playerList = player[rodzaj]
            let list_return = [[], [], []]
            for( let i=0; i<list_choose_index.length; i++) {
                let index = list_choose_index[i]
                let choose_player = ["", "", ""]
                if( index > -1 ) {
                    choose_player[0] = playerList[index][0]+" "+playerList[index][1]
                    choose_player[1] = playerList[index][2]
                    choose_player[2] = playerList[index][3]
                }
                for( let j=0; j<3; j++) list_return[j].push(choose_player[j])
            }
            return list_return
        }
        
        function zgloszenieDruzyny_getLastIndexPlayer(list_playerName, rodzaj) {
            let last_index = 4
            if( rodzaj == "SM") last_index = 6
            for( let i=last_index; i<list_playerName.length; i++) {
                if( list_playerName[i] != "") last_index = i+1
            }
            return last_index
        }
        
        function pdfDoc_findLongestWordInArray(arr, font) {
            let result = ""
            for( let i=0; i<arr.length; i++) {
                if(font.widthOfTextAtSize(result, 30) < font.widthOfTextAtSize(arr[i], 30)) result = arr[i]
            }
            return result
        }
        
        async function kartyZmian_createPdf() {
            const pdfDoc = await PDFDocument.create();
            const page = pdfDoc.addPage();
            const el = document.getElementsByClassName("kartyZmian_select")
            let list_choosedOptions = []
            for( let i=0; i<4; i++) list_choosedOptions.push(parseInt(el[i].value))
            
            const kartyZmian = await kartyZmian_loadKartyZmian(pdfDoc)
            const { width, height } = page.getSize()
            for ( let i=0; i<4; i++ )
                page.drawPage(
                    kartyZmian[list_choosedOptions[i]], 
                    {x: width/2 * ((4-i)%2), y: height/2 * parseInt((3-i)/2)}
                );
            list_wsp = [
                {start: {x: 0, y: height/2}, end: {x: width, y: height/2}},
                {start: {x: width/2, y: 0}, end: {x: width/2, y: height}}
            ]
            for( let i=0; i<2; i++ ) {
                page.drawLine({
                  start: { x: list_wsp[i].start.x, y: list_wsp[i].start.y },
                  end: { x: list_wsp[i].end.x, y: list_wsp[i].end.y},
                  thickness: 2,
                  color: rgb(0, 0, 0)
                })  
            }
            return pdfDoc
        }

        async function kartyZmian_onPrint() {
            const pdfDoc = await kartyZmian_createPdf()
            pdfDoc_print(pdfDoc)
        }

        async function kartyZmian_onSave() {
            const pdfDoc = await kartyZmian_createPdf()
            pdfDoc_download(pdfDoc, "kartyZmian")
        }

        async function kartyZmian_loadKartyZmian(pdfDoc) {
            const list_url = ["pdf/home_E1.pdf", "pdf/home_E2.pdf", "pdf/guest_E1.pdf", "pdf/guest_E2.pdf", "pdf/kartaGryZawodnika.pdf"]
            let list_kartyZmian = []
            for( let i=0; i<list_url.length; i++) {
                let pdfBites = await fetch(list_url[i]).then((res) => res.arrayBuffer());
                let [doc] = await pdfDoc.embedPdf(pdfBites);
                list_kartyZmian.push(doc)
            }
            return list_kartyZmian
        }
        
        async function getPlayerFromLicencja() {
            let lista = {"SM": {}, "CLJ": {}}
            await getPlayerFromLicencja_getData().then(function(all_player) {
                all_player = all_player.split("\r\n")
                for( let i=1; i<all_player.length; i++) {
                    let info_player = all_player[i].split(",")
                    getPlayerFromLicencja_analizaGracza(lista, info_player)
                }
            })
            for (const keyMain in lista) {
              for (const key in lista[keyMain]) lista[keyMain][key].sort()
            }
            return lista
        }
        
        function getPlayerFromLicencja_getData() {
            return $.ajax({
              type: "GET",  
              url: "excel/licencje.csv",
              dataType: "text",       
              success: function(response) { return response }   
            });
        }
        
        function getPlayerFromLicencja_analizaGracza(lista, player) {
            const index_name = 3
            const index_club = 4
            const index_category = 5
            const index_thisSezon = 8
            const index_wypozyczenieWhere = 9
            const index_wypozyczenieKindLiga = 10

            if( player[index_thisSezon] == "NIE" ) return

            const kategorie = {
                CLJ: ["Juniorka młodsza", "Junior młodszy", "Juniorka", "Junior"],
                SM: ["Junior młodszy", "Junior", "Senior"],
            }

            //CLJ
            if( kategorie.CLJ.includes(player[index_category]) ) {
                if( lista.CLJ[player[index_club]] === undefined) lista.CLJ[player[index_club]] = []
                lista.CLJ[player[index_club]].push(player[index_name])
            }

            //SM
            if( kategorie.SM.includes(player[index_category]) ) {
                klub = ""
                if(player[index_wypozyczenieKindLiga].toLowerCase() == "superliga mężczyzn")
                    klub = player[index_wypozyczenieWhere]
                else klub = player[index_club]

                if( lista.SM[klub] === undefined) lista.SM[klub] = []
                lista.SM[klub].push(player[index_name])
            }
        }
        
        function kartyGryZawodnikow_afterChangeKind(rodzaj) {
            const table = document.getElementById("kartyGryZawodnika_tablePlayer")
            table.innerHTML = ""
            
            const list_player_home = kartyGryZawodnikow_getListPlayerHome(rodzaj)
            const player_home_select = kartyGryZawodnikow_getPlayerSelect(
                list_player_home, "kartyGryZawodnika_playerSelect_home")
                        
            kartyGryZawodnikow_addSelectClub(rodzaj)
            
            let code = "<tr><th colspan='3'>Wybór graczy</th></tr>";
            code += "<tr><th></th><th>Gospodarz</th><th>Gość</th></tr>"
            
            const howManyPlayer = rodzaj == "SM" ? 6 : 4;
            for( let i=1; i<=howManyPlayer; i++) {
                code += `<tr>
                            <td>Gracz ${i}.</td>
                            <td class='kartyGryZawodnika_playerSelectContener_home'>${player_home_select}</td>
                            <td class='kartyGryZawodnika_playerSelectContener_guest'></td>
                         </tr>`
            }
            table.innerHTML = code;
            
            kartyGryZawodnikow_changeClub()
        }
        
        function kartyGryZawodnikow_getListPlayerHome(rodzaj) {
            const list_player = player[rodzaj]
            let list_name = []
            for( let i=0; i<list_player.length; i++) list_name.push(list_player[i][1]+" "+list_player[i][0])
            list_name.sort()
            return list_name
        }
        
        function kartyGryZawodnikow_getPlayerSelect(players, className="") {
            players.unshift("")
            code = `<select class="${className}">`
            for( let i=0; i<players.length; i++ ) {
                player_name = players[i]
                code += `<option value='${player_name}'>${player_name}</option>`
            }
            code += "</select>"
            return code
        }
        
        function kartyGryZawodnikow_addSelectClub(rodzaj) {
            let kluby = Object.keys(list_player[rodzaj])
            var index = kluby.indexOf("KS Start Gostyń");
            if (index !== -1) kluby.splice(index, 1);
            let code = '<select id="kartyGryZawodnika_selectTeam" onChange="kartyGryZawodnikow_changeClub()">'
            for( let i=0; i<kluby.length; i++) code += `<option value="${kluby[i]}">${kluby[i]}</option>`
            code += "</select>"
            document.getElementById("kartyGryZawodnika_selectTeamContener").innerHTML = code
        }
        
        function kartyGryZawodnikow_changeClub() {
            const rodzaj = document.getElementById("mainSetting_rodzaj").value;
            const team = document.getElementById("kartyGryZawodnika_selectTeam").value;
            const players = list_player[rodzaj][team]
            const select_player = kartyGryZawodnikow_getPlayerSelect(
                players, "kartyGryZawodnika_playerSelect_guest")
            const elements = document.getElementsByClassName("kartyGryZawodnika_playerSelectContener_guest")
            for( let i=0; i<elements.length; i++) elements[i].innerHTML = select_player
        }
        
        async function kartyGryZawodnika_createPdf() {
            const rodzaj = document.getElementById("mainSetting_rodzaj").value;
            const kolejnoscKart = document.getElementById("kartaGryZawodnika_kolejnoscKart").value
            const nameMecz = document.getElementById("kartaGryZawodnika_nameMecz").value
            let details = {home: {}, guest: {}}
            details.home.nameTeam = "KS Start Gostyń"
            details.guest.nameTeam = document.getElementById("kartyGryZawodnika_selectTeam").value
            
            details.home.drawTeam = document.getElementById("kartyGryZawodnika_nameTeam_home").checked
            details.guest.drawTeam = document.getElementById("kartyGryZawodnika_nameTeam_guest").checked
            
            details.home.drawNameMecz = document.getElementById("kartyGryZawodnika_mecz_home").checked
            details.guest.drawNameMecz = document.getElementById("kartyGryZawodnika_mecz_guest").checked
            
            details.home.drawTory = document.getElementById("kartyGryZawodnika_tory_home").checked
            details.guest.drawTory = document.getElementById("kartyGryZawodnika_tory_guest").checked
            
            details.home.drawNrStart = document.getElementById("kartyGryZawodnika_nrStart_home").checked
            details.guest.drawNrStart = document.getElementById("kartyGryZawodnika_nrStart_guest").checked
            
            details.home.listSelect = document.getElementsByClassName("kartyGryZawodnika_playerSelect_home")
            details.guest.listSelect = document.getElementsByClassName("kartyGryZawodnika_playerSelect_guest")
            
            let kartyGry_data = []
            
            if( kolejnoscKart == "1") {
                const kind = ["home", "guest"]
                for( let i=0; i<2; i++ ) {
                    let data = details[kind[i]]
                    for(let j=0; j<data.listSelect.length; j++ ) {
                        kartyGry_data.push(kartyGryZawodnika_createData(data.listSelect[j].value, nameMecz, data.nameTeam, j+1, data.drawNameMecz, data.drawTeam, data.drawNrStart, data.drawTory, rodzaj, i))
                    }
                }
            }
            else {
                const kind = ["home", "guest"]
                for(let j=0; j<details.home.listSelect.length; j++ ) {
                    for( let i=0; i<2; i++ ) {
                        let data = details[kind[i]]
                        kartyGry_data.push(kartyGryZawodnika_createData(data.listSelect[j].value, nameMecz, data.nameTeam, j+1, data.drawNameMecz, data.drawTeam, data.drawNrStart, data.drawTory, rodzaj, i))
                    }
                }
            }
            
            let strony = []
            for( let i=0; i<Math.ceil(kartyGry_data.length/4); i++ ) strony.push(1) 
            pdfDoc = await pdfDoc_getEmptyForm(strony)
            const pages = pdfDoc.getPages()
            const skala = pdfDoc_getScala(pages[0])            
            const font = await pdfDoc_getFont()
            
            kartyGryZawodnika_drawData(pages, kartyGry_data, skala, font)
            
            return pdfDoc
        }

        async function kartyGryZawodnika_onPrint() {
            const pdfDoc = await kartyGryZawodnika_createPdf()
            pdfDoc_print(pdfDoc)
        }

        async function kartyGryZawodnika_onSave() {
            const pdfDoc = await kartyGryZawodnika_createPdf()
            pdfDoc_download(pdfDoc, "kartyGryZawodnika")
        }
        
        function kartyGryZawodnika_createData(namePlayer, nameMecz, nameTeam, nrStart, drawMecz, drawTeam, drawNrStart, drawTory, rodzaj, isGuest) {
            let firstname = ""
            let surname = ""
            if( namePlayer != "" ) {
                firstname = namePlayer.split(" ")[1]
                surname = namePlayer.split(" ")[0]
            }
            if( !drawMecz ) nameMecz = ""
            if( !drawTeam ) nameTeam = ""
            
            const list_tory = {
                CLJ: [['1','2','4','3'], ['2','1','3','4'], ['3','4','2','1'], ['4','3','1','2']], 
                SM: [['1','2','4','3'], ['2','1','3','4'], ['3','4','6','5'], ['4','3','5','6'], ['5','6','2','1'], ['6','5','1','2']]
            }
            tory = ["", "", "", ""]
            if( drawTory ) {
                let index = 0
                if( rodzaj == "SM" ) index = (nrStart-1)%3
                else index = (nrStart-1)%2
                index = index*2+isGuest
                tory = list_tory[rodzaj][index]
            }
            
            if( !drawNrStart ) nrStart = " "
            else nrStart = nrStart.toString()
            
            let result = {firstname, surname, nameMecz, nameTeam, nrStart, tory}
            return result
        }
        
        function kartyGryZawodnika_drawData(pages, kartyGry_data, skala, font) {
            for(let i=0; i<kartyGry_data.length; i++) {
                let index_page = Math.floor(i/4)
                let downRow = (i%4) > 1
                let rightColumn = (i%2) == 1
                kartyGryZawodnika_drawData_karta(pages[index_page], kartyGry_data[i], skala, font, rightColumn, downRow)
            }
        }
        
        function kartyGryZawodnika_drawData_karta(page, dataKarta, skala, font, right, down) {
            const wsp = {
                nameMecz: {x: 87, y: 1092, w:277, h: 30}, 
                firstname: {x: 77, y: 1065, w:199, h:30}, 
                surname: {x: 115, y: 1038, w: 161, h: 30}, 
                nameTeam: {x: 85, y: 1010, w: 191, h: 30}, 
                nrStart: {y: 1015, xLeft: 303, xRight: 373, h: 75, w: 70}, 
                tory: {y: 925, xLeft: 41, xRight: 105, h: 44, w: 50}
            }
            const rightKarta = 413*right
            const downKarta = 582*down
            const nextRow = 40
            const list_kind = ["nameMecz", "firstname", "surname", "nameTeam"]
            for(let i=0; i<list_kind.length; i++) {
                kind = list_kind[i]
                let fontSize = pdfDoc_getMaxFontSize(font, wsp[kind].h*skala, wsp[kind].w*skala, dataKarta[kind])
                pdfDoc_drawText(page, dataKarta[kind], wsp[kind].y-downKarta, wsp[kind].x+rightKarta, font, fontSize, skala)
            }
            console.log("|",dataKarta.nrStart,"|")
            fontSize = pdfDoc_getMaxFontSize(font, wsp.nrStart.h*skala, wsp.nrStart.w*skala, dataKarta.nrStart)
            pdfDoc_drawCenterText(page, dataKarta.nrStart, wsp.nrStart.y-downKarta, wsp.nrStart.xLeft+rightKarta, wsp.nrStart.xRight+rightKarta, font, fontSize, skala)
            
            fontSize = pdfDoc_getMaxFontSize(font, wsp.tory.h*skala, wsp.tory.w*skala, "0")
            for(let i=0; i<4; i++) {
                pdfDoc_drawCenterText(page, dataKarta.tory[i], wsp.tory.y-downKarta-nextRow*i, wsp.tory.xLeft+rightKarta, wsp.tory.xRight+rightKarta, font, fontSize, skala)
            }
        }
    </script>
</html>












